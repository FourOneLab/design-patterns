# 虚拟钱包系统

基于贫血模型的MVC三层架构，是标准的Web项目开发模式，但是违反面向对象编程风格，是一种彻底的面向过程编程，被称为[反模式](https://zh.wikipedia.org/wiki/%E5%8F%8D%E9%9D%A2%E6%A8%A1%E5%BC%8F)。

领域驱动设计（Domain Driven Design，DDD）的盛行，使得基于贫血模型的传统开发模式被人诟病，基于充血模型的DDD开发模式被人提倡

## 背景知识

### 基于贫血模型的传统开发模式

传统MVC三层架构开发模式：

- M：Model，数据层
- V：View，展示层
- C：Controller，逻辑层

一般在前后端分离的项目中，后端负责暴露接口给前端调用，此时，后端项目被分为：

- Repository层：负责数据访问
- Service层：负责业务逻辑
- Controller层：负责暴露接口

> 依赖数据库开发的Web项目，基本上地分层思路都是这样的。

[贫血模型](./anaemic-domain-model.go)的示例，平时开发Web项目，基本都是按照这样的形式组织代码。

UserEntity 和 UserRepository 组成数据访问层，UserBo 和 UserService 组成业务逻辑层，UserVo 和 UserController 组成接口层。

从代码中发现，UserBo 是一个纯粹的数据结果，只有数据没有业务逻辑。业务逻辑集中在 UserService 中，通过 UserService 来操作 UserBo。也就是说 Service 层的数据和业务逻辑被分割为 BO 和 Service 两个类。

像 UserBo 这样只包含数据，没有业务逻辑的类称为**贫血模型**。因此，UserVo 和 UserEntity 也是贫血模型，这样的设计破坏类面向对象**封装**特性，是一种面向过程编程风格。

### 基于充血模型的DDD开发模式

在贫血模型中，数据和业务逻辑被分割在不同的类中，在充血模型中，数据和对应的业务逻辑被封装在同一个类中，因此满足面向对象的封装特性，是一种面向对象编程风格。

DDD，主要是用来指导如何解耦业务系统，划分业务模块，定义业务领域模型及交互。借着微服务的东风，领域驱动设计火了起来。

> 除了监控、调用链路追踪，API网关等服务治理能力外，微服务的主要工作是针对公司业务系统，合理地做微服务拆分，领域驱动设计就是用来指导服务划分的，所以，微服务加速来领域驱动设计的盛行。

做好领域驱动设计的关键是对业务系统的熟悉程度，而不是，对DDD概念的掌握程度，所以DDD有点像敏捷开发、SOA、PAAS等概念。因此。懂DDD的概念就行，熟悉业务才是王道。

基于充血模型的DDD开发也是按照MVC三层架构分层的：

- Repository层：负责数据存取
- Service层：负责核心业务逻辑【与贫血模型的开发模式的主要区别在这里】
- Controller层：负责暴露接口

|-|贫血模型|充血模型|
|---|---|---|
|Service层|包含 Service 类（业务逻辑）和 BO 类（数据）|包含 Service 类（这个很薄）和 Domain 类（相当于BO，但包含业务逻辑）|

- 基于贫血模型的传统开发模式：重 Service 而轻 BO
- 基于充血模型的DDD开发模式：轻 Service 而重 Domain

### 基于贫血模型的传统开发模式受欢迎的原因

有多流行呢，Spring 框架的官方 demo 也是基于贫血模型的传统开发模式编写的。

> 回忆下面向过程的弊端：数据和操作分离，数据本身的操作不受限制，任何代码可以随意修改数据。

流行的原因：

1. 业务系统比较简单，基于 SQL 的 CURD，不需要精心设计的充血模型。（业务简单，设计出来的领域模型会比较淡薄，和贫血模型差别不大，意义不大。）
2. 充血模型的设计比贫血模型难很多。（充血模型是一种面向对象编程风格，从一开始就要定义好数据暴露的操作，和业务逻辑，而不像贫血模型，一开始只要定义数据，业务逻辑是随着开发需求慢慢定义的，实现不需要太多设计。）
3. 思维固化，转型成本高。（转向充血模型和领域驱动设计，有一定地学习成本，在开发中没有遇到痛点的时候，很难推动。）

### 优先考虑基于充血模型的DDD开发模式的项目特征

- 基于贫血模型的传统开发模式：适合业务比较简单的系统
- 基于充血模型的DDD开发模式：适合业务比较复杂的系统，（如，包含各种利息计算模型、还款模型等复杂业务的金融系统。）

落地到代码层面的区别：一个将业务逻辑放到 Service 类中，一个将业务逻辑放到 Domain 领域模型中。更重要的区别是，两种不同的开发模式导致的开发流程不同，充血模式的开发流程在应对复杂业务系统的开发时更有优势。

> 最常见的地开发模式，基于 SQL 驱动（SQL-Driven）的开发模式：
> 
> 1. 接口后端接口开发需求，查看接口需要的数据对应数据库中的表
> 2. 思考编写 SQL 获取数据
> 3. 定义 Entity、BO、VO
> 4. 模版式的往 Repository、Service、Controller 类中添加代码
> 
> 业务逻辑包裹在一个大 SQL 中，Service 层做的事情很少，SQL针对特定业务功能，复用性差，新业务需要写新的 SQL，导致各种类似的 SQL 满天飞。

在这样地开发模式中，没有领域模型，么哦有oop，没有代码复用的意识。对于简单业务系统，问题不大，对于复杂业务系统，难易维护。

> 基于充血模型的DDD开发模式：
> 
> 1. 梳理所有业务
> 2. 定义领域模型所包含的属性和方法，（领域模型相当于可服用的中间层，新功能需求基于定义好的领域模型来完成）

**越复杂的系统，对代码的复用性越高，易维护性要求高，应该花更多的时间和精力在前期的设计**。基于充血模型的DDD开发模式，就需要前期大量的业务调研，领域模型设计，所以适合复杂的业务系统开发。

但是DDD不是银弹，对于不复杂的系统，基于贫血模型的传统开发模式简单够用，基于充血模型的DDD开发模式就大材小用来，无法发挥作用。